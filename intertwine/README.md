# mikenakis-intertwine

A framework for converting back and forth between any interface and the _Normal Form of Interfaces_, which is a single-method interface of the form `Object anyCall( MethodKey key, Object[] arguments )`.

<p align="center">
<img title="mikenakis-intertwine logo" src="mikenakis-intertwine.svg" width="256"/><br/>
The mikenakis-intertwine logo<br/>
</p>

## Description
                                                                                                                   
Any conceivable interface can be described using the following single-method interface:

    interface AnyCall
    {
        Object anyCall( MethodKey key, Object[] arguments );
    }

We call this the _Normal Form_ of interfaces.
- The particular interface method that is being invoked is uniquely identified using a `MethodKey`. (More on this later.)
- The arguments of the method being invoked are represented as an array of `Object`.
- The return value of the method is represented as an `Object`. If the method is of `void` return type then the value returned by `anyCall` is unspecified. (It will in all likelihood be `null`, but nobody should rely on this.)   

The 'method key' is an abstraction of the actual mechanism used to uniquely identify interface methods, which can be any of the following: 
- The identity of the `java.lang.reflect.Method` object that corresponds to the method.
- A string representation of the prototype of the method.
- A zero-based method index. <sup>(*1)</sup>

For any interface `T` it is possible to have an **_Entwiner_** and an **_Untwiner_**.
- The entwiner of interface `T` is an object that implements `T` by delegating to an instance of `AnyCall`.
- The untwiner of interface `T` is an object that implements `AnyCall` by delegating to an instance of `T`.

More specifically, the entwiner of `T` does the following:
- Accepts an instance of `AnyCall` as a constructor parameter and stores it in `final` field `exitPoint`.
- Implements each method of `T` as follows:
  - Packs the parameters that were passed to the method into an array of `Object`, performing any boxing necessary.
  - Invokes `exitPoint` passing it a key that uniquely identifies the method, and the array of parameters.
  - Returns, possibly after unboxing, whatever was returned by the invocation of `exitPoint`.

The untwiner of `T` performs the opposite and complementary operation of the entwiner, namely:
- Accepts an instance of `T` as a constructor parameter and stores it in `final` field `exitPoint`.
- Implements the `anyCall` method of the `AnyCall` interface as follows:
  - It uses the supplied `MethodKey` to determine which method of `T` is being invoked, and for each method it does the following:
    - Unpacks the parameters from the array of `Object`, performing any unboxing necessary.
    - Invokes the corresponding method of `exitPoint`, passing it the unpacked parameters.
    - Returns, possibly after boxing, whatever was returned by the method, or `null` if the method was of `void` return type.

Writing entwiners and untwiners by hand is a tedious and error-prone task; *mikenakis-intertwine* is a framework that uses bytecode generation to automatically create _Entwiners_ and _Untwiners_ for any interface.

Entwiners generated by *mikenakis-intertwine* are a lot like the objects created by the built-in Dynamic Proxy facility of Java, (see method `newProxyInstance()` in class `Proxy` of package `java.lang.reflect`) with one very important difference: **they do not mess with exceptions.**

  - <small>The dynamic proxy that is built into the Java Runtime Environment has the extremely annoying habit of catching and rethrowing exceptions, which is a practice devoid of any usefulness whatsoever, but it does severely hamper debugging. 
  - That's because debugging relies on having the debugger always stop on any unhandled exception, but a catch-and-rethrow construct in the call tree causes exceptions thrown underneath it to appear as caught exceptions to the debugger, so the debugger does not stop at the location where they are thrown; instead, it stops at the location where they are rethrown, which is useless. 
  - The entwiners created by *mikenakis-intertwine* can serve as debugger-friendly replacements for the ill-behaving objects generated by Java's built-in dynamic proxy facility.</small>

Untwiners generated by *mikenakis-intertwine* are unlike anything that Java ships with. (For some reason, even though Java contains a dynamic proxy facility, it does not contain its other half; *mikenakis-intertwine* fixes this omission.)  An untwiner can be implemented using reflection, but it is slow, and it can also be implemented using method handles, which are indeed considerably faster than reflection, but still not as fast as possible. The entwiners and untwiners generated by mikenakis-intertwine are about as fast as their hand-written counterparts, which is as fast as it gets.    
     
<hr>

<sup>(*1)</sup> Note that if both the caller and the callee live in the same JVM, then each method index will always match the same method; however, if they do not live in the same JVM, then the question of which method is addressed by each method index can get complicated: the caller and the callee will have to somehow negotiate the method indexes, so that the indexes understood by the caller refer to the same methods as those understood by the callee.

## License

This creative work is explicitly published under ***No License***. This means that I remain the exclusive copyright holder of this creative work, and you may not do anything with it other than view its source code and admire it. More information here: [michael.gr - Open Source but No License.](https://blog.michael.gr/2018/04/open-source-but-no-license.html)

If you would like to do anything more with this creative work, contact me.

## Coding style

When I write code as part of a team of developers, I use the teams' coding style.  
However, when I write code for myself, I use _**my very ownâ„¢**_ coding style.

More information: [michael.gr - On Coding Style](https://blog.michael.gr/2018/04/on-coding-style.html)
